"use strict";function funescape(a,b,c){var d="0x"+b-65536;return d!==d||c?b:0>d?String.fromCharCode(d+65536):String.fromCharCode(d>>10|55296,1023&d|56320)}function unescapeCSS(a){return a.replace(re_escape,funescape)}function getClosingPos(a){for(var b=1,c=1,d=a.length;c>0&&d>b;b++)"("===a.charAt(b)?c++:")"===a.charAt(b)&&c--;return b}function parse(a,b){function c(){var b=a.match(re_name)[0];return a=a.substr(b.length),unescapeCSS(b)}a=(a+"").trimLeft();for(var d,e,f,g=[],h=[],i=!1;""!==a;)if(re_name.test(a))i&&(h.push({type:"descendant"}),i=!1),f=c(),b&&("lowerCaseTags"in b?!b.lowerCaseTags:b.xmlMode)||(f=f.toLowerCase()),h.push({type:"tag",name:f});else if(re_ws.test(a))i=!0,a=a.trimLeft();else{if(e=a.charAt(0),a=a.substr(1),e in simpleSelectors){h.push({type:simpleSelectors[e]}),a=a.trimLeft(),i=!1;continue}if(","===e){if(0===h.length)throw new SyntaxError("empty sub-selector");g.push(h),h=[],a=a.trimLeft(),i=!1;continue}if(i&&(h.push({type:"descendant"}),i=!1),"*"===e)h.push({type:"universal"});else if(e in attribSelectors)h.push({type:"attribute",name:attribSelectors[e][0],action:attribSelectors[e][1],value:c(),ignoreCase:!1});else if("["===e){if(d=a.match(re_attr),!d)throw new SyntaxError("Malformed attribute selector: "+a);a=a.substr(d[0].length),f=unescapeCSS(d[1]),b&&("lowerCaseAttributeNames"in b?!b.lowerCaseAttributeNames:b.xmlMode)||(f=f.toLowerCase()),h.push({type:"attribute",name:f,action:actionTypes[d[2]],value:unescapeCSS(d[4]||d[5]||""),ignoreCase:!!d[6]})}else{if(":"!==e)throw new SyntaxError("Unmatched selector: "+e+a);if(f=c().toLowerCase(),d=null,"("===a.charAt(0)){var j=getClosingPos(a);d=a.substr(1,j-2),a=a.substr(j)}h.push({type:"pseudo",name:f,data:d})}}if(g.length>0&&0===h.length)throw new SyntaxError("empty sub-selector");return g.push(h),g}module.exports=parse;var re_ws=/^\s/,re_name=/^(?:\\.|[\w\-\u00c0-\uFFFF])+/,re_escape=/\\([\da-f]{1,6}\s?|(\s)|.)/gi,re_attr=/^\s*((?:\\.|[\w\u00c0-\uFFFF\-])+)\s*(?:(\S?)=\s*(?:(['"])(.*?)\3|(#?(?:\\.|[\w\u00c0-\uFFFF\-])*)|)|)\s*(i)?\]/,actionTypes={__proto__:null,undefined:"exists","":"equals","~":"element","^":"start",$:"end","*":"any","!":"not","|":"hyphen"},simpleSelectors={__proto__:null,">":"child","<":"parent","~":"sibling","+":"adjacent"},attribSelectors={__proto__:null,"#":["id","equals"],".":["class","element"]};
function DomHandler(a,b,c){"object"==typeof a?(c=b,b=a,a=null):"function"==typeof b&&(c=b,b=defaultOpts),this._callback=a,this._options=b||defaultOpts,this._elementCB=c,this.dom=[],this._done=!1,this._tagStack=[],this._parser=this._parser||null}var ElementType=require("domelementtype"),re_whitespace=/\s+/g,NodePrototype=require("./lib/node"),ElementPrototype=require("./lib/element"),defaultOpts={normalizeWhitespace:!1,withStartIndices:!1};DomHandler.prototype.onparserinit=function(a){this._parser=a},DomHandler.prototype.onreset=function(){DomHandler.call(this,this._callback,this._options,this._elementCB)},DomHandler.prototype.onend=function(){this._done||(this._done=!0,this._parser=null,this._handleCallback(null))},DomHandler.prototype._handleCallback=DomHandler.prototype.onerror=function(a){if("function"==typeof this._callback)this._callback(a,this.dom);else if(a)throw a},DomHandler.prototype.onclosetag=function(){var a=this._tagStack.pop();this._elementCB&&this._elementCB(a)},DomHandler.prototype._addDomElement=function(a){var b=this._tagStack[this._tagStack.length-1],c=b?b.children:this.dom,d=c[c.length-1];a.next=null,this._options.withStartIndices&&(a.startIndex=this._parser.startIndex),this._options.withDomLvl1&&(a.__proto__="tag"===a.type?ElementPrototype:NodePrototype),d?(a.prev=d,d.next=a):a.prev=null,c.push(a),a.parent=b||null},DomHandler.prototype.onopentag=function(a,b){var c={type:"script"===a?ElementType.Script:"style"===a?ElementType.Style:ElementType.Tag,name:a,attribs:b,children:[]};this._addDomElement(c),this._tagStack.push(c)},DomHandler.prototype.ontext=function(a){var b,c=this._options.normalizeWhitespace||this._options.ignoreWhitespace;!this._tagStack.length&&this.dom.length&&(b=this.dom[this.dom.length-1]).type===ElementType.Text?c?b.data=(b.data+a).replace(re_whitespace," "):b.data+=a:this._tagStack.length&&(b=this._tagStack[this._tagStack.length-1])&&(b=b.children[b.children.length-1])&&b.type===ElementType.Text?c?b.data=(b.data+a).replace(re_whitespace," "):b.data+=a:(c&&(a=a.replace(re_whitespace," ")),this._addDomElement({data:a,type:ElementType.Text}))},DomHandler.prototype.oncomment=function(a){var b=this._tagStack[this._tagStack.length-1];if(b&&b.type===ElementType.Comment)return void(b.data+=a);var c={data:a,type:ElementType.Comment};this._addDomElement(c),this._tagStack.push(c)},DomHandler.prototype.oncdatastart=function(){var a={children:[{data:"",type:ElementType.Text}],type:ElementType.CDATA};this._addDomElement(a),this._tagStack.push(a)},DomHandler.prototype.oncommentend=DomHandler.prototype.oncdataend=function(){this._tagStack.pop()},DomHandler.prototype.onprocessinginstruction=function(a,b){this._addDomElement({name:a,data:b,type:ElementType.Directive})},module.exports=DomHandler;
function traverseParents(a,b,c,d){for(var e=[];b&&e.length<d;)(!c||exports.filter.call([b],c,a).length)&&e.push(b),b=b.parent;return e}var _=require("lodash"),select=require("css-select"),utils=require("../utils"),domEach=utils.domEach,uniqueSort=require("htmlparser2").DomUtils.uniqueSort,isTag=utils.isTag;exports.find=function(a){var b,c=_.reduce(this,function(a,b){return a.concat(_.filter(b.children,isTag))},[]),d=this.constructor.contains;return a&&"string"!=typeof a?(b=a.cheerio?a.get():[a],this._make(b.filter(function(a){var b,c;for(b=0,c=this.length;c>b;++b)if(d(this[b],a))return!0},this))):this._make(select(a,c,this.options))},exports.parent=function(a){var b=[];return domEach(this,function(a,c){var d=c.parent;d&&b.indexOf(d)<0&&b.push(d)}),arguments.length&&(b=exports.filter.call(b,a,this)),this._make(b)},exports.parents=function(a){var b=[];return this.get().reverse().forEach(function(c){traverseParents(this,c.parent,a,1/0).forEach(function(a){-1===b.indexOf(a)&&b.push(a)})},this),this._make(b)},exports.parentsUntil=function(a,b){var c,d,e=[];return"string"==typeof a?c=select(a,this.parents().toArray(),this.options)[0]:a&&a.cheerio?d=a.toArray():a&&(c=a),this.toArray().reverse().forEach(function(a){for(;(a=a.parent)&&(c&&a!==c||d&&-1===d.indexOf(a)||!c&&!d);)isTag(a)&&-1===e.indexOf(a)&&e.push(a)},this),this._make(b?select(b,e,this.options):e)},exports.closest=function(a){var b=[];return a?(domEach(this,function(c,d){var e=traverseParents(this,d,a,1)[0];e&&b.indexOf(e)<0&&b.push(e)}.bind(this)),this._make(b)):this._make(b)},exports.next=function(a){if(!this[0])return this;var b=[];return _.forEach(this,function(a){for(;a=a.next;)if(isTag(a))return void b.push(a)}),a?exports.filter.call(b,a,this):this._make(b)},exports.nextAll=function(a){if(!this[0])return this;var b=[];return _.forEach(this,function(a){for(;a=a.next;)isTag(a)&&-1===b.indexOf(a)&&b.push(a)}),a?exports.filter.call(b,a,this):this._make(b)},exports.nextUntil=function(a,b){if(!this[0])return this;var c,d,e=[];return"string"==typeof a?c=select(a,this.nextAll().get(),this.options)[0]:a&&a.cheerio?d=a.get():a&&(c=a),_.forEach(this,function(a){for(;(a=a.next)&&(c&&a!==c||d&&-1===d.indexOf(a)||!c&&!d);)isTag(a)&&-1===e.indexOf(a)&&e.push(a)}),b?exports.filter.call(e,b,this):this._make(e)},exports.prev=function(a){if(!this[0])return this;var b=[];return _.forEach(this,function(a){for(;a=a.prev;)if(isTag(a))return void b.push(a)}),a?exports.filter.call(b,a,this):this._make(b)},exports.prevAll=function(a){if(!this[0])return this;var b=[];return _.forEach(this,function(a){for(;a=a.prev;)isTag(a)&&-1===b.indexOf(a)&&b.push(a)}),a?exports.filter.call(b,a,this):this._make(b)},exports.prevUntil=function(a,b){if(!this[0])return this;var c,d,e=[];return"string"==typeof a?c=select(a,this.prevAll().get(),this.options)[0]:a&&a.cheerio?d=a.get():a&&(c=a),_.forEach(this,function(a){for(;(a=a.prev)&&(c&&a!==c||d&&-1===d.indexOf(a)||!c&&!d);)isTag(a)&&-1===e.indexOf(a)&&e.push(a)}),b?exports.filter.call(e,b,this):this._make(e)},exports.siblings=function(a){var b=this.parent(),c=_.filter(b?b.children():this.siblingsAndMe(),function(a){return isTag(a)&&!this.is(a)},this);return void 0!==a?exports.filter.call(c,a,this):this._make(c)},exports.children=function(a){var b=_.reduce(this,function(a,b){return a.concat(_.filter(b.children,isTag))},[]);return void 0===a?this._make(b):exports.filter.call(b,a,this)},exports.contents=function(){return this._make(_.reduce(this,function(a,b){return a.push.apply(a,b.children),a},[]))},exports.each=function(a){for(var b=0,c=this.length;c>b&&a.call(this[b],b,this[b])!==!1;)++b;return this},exports.map=function(a){return this._make(_.reduce(this,function(b,c,d){var e=a.call(c,d,c);return null==e?b:b.concat(e)},[]))};var makeFilterMethod=function(a){return function(b,c){var d;return c=c||this,d="string"==typeof b?select.compile(b,c.options):"function"==typeof b?function(a,c){return b.call(a,c,a)}:b.cheerio?b.is.bind(b):function(a){return b===a},c._make(a(this,d))}};exports.filter=makeFilterMethod(_.filter),exports.not=makeFilterMethod(_.reject),exports.has=function(a){var b=this;return exports.filter.call(this,function(){return b._make(this).find(a).length>0})},exports.first=function(){return this.length>1?this._make(this[0]):this},exports.last=function(){return this.length>1?this._make(this[this.length-1]):this},exports.eq=function(a){return a=+a,0===a&&this.length<=1?this:(0>a&&(a=this.length+a),this[a]?this._make(this[a]):this._make([]))},exports.get=function(a){return null==a?Array.prototype.slice.call(this):this[0>a?this.length+a:a]},exports.index=function(a){var b,c;return 0===arguments.length?(b=this.parent().children(),c=this[0]):"string"==typeof a?(b=this._make(a),c=this[0]):(b=this,c=a.cheerio?a[0]:a),b.get().indexOf(c)},exports.slice=function(){return this._make([].slice.apply(this,arguments))},exports.end=function(){return this.prevObject||this._make([])},exports.add=function(a,b){for(var c=this._make(a,b),d=uniqueSort(c.get().concat(this.get())),e=0;e<d.length;++e)c[e]=d[e];return c.length=d.length,c},exports.addBack=function(a){return this.add(arguments.length?this.prevObject.filter(a):this.prevObject)};